{{/*
  Booking widget for tour packages
  Usage: {{ partial "booking-widget.html" . }}
*/}}
<div class="bg-white rounded-lg shadow-lg p-6 sticky top-24">
  <h3 class="text-xl font-bold mb-4">Angebot anfordern</h3>
  
  <!-- Price Display -->
  {{ with .Params.pricefrom }}
    <div class="mb-4">
      <span class="text-3xl font-bold text-yellow-600">{{ . }}€</span>
      <span class="text-gray-600">pro Person</span>
    </div>
  {{ end }}
  
  <!-- Duration Badge -->
  {{ with .Params.duration }}
    <div class="mb-4">
      <span class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm font-medium">
        ⏱️ {{ . }}
      </span>
    </div>
  {{ end }}
  
  <!-- Quick Booking Form -->
  <form id="quickBookingForm" class="space-y-4">
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Reisedatum</label>
      <input type="date" name="travelDate" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-yellow-500 focus:border-transparent" required>
    </div>
    
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Anzahl Personen</label>
      <select name="participants" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-yellow-500 focus:border-transparent" required>
        <option value="">Wählen Sie...</option>
        <option value="1">1 Person</option>
        <option value="2">2 Personen</option>
        <option value="3">3 Personen</option>
        <option value="4">4 Personen</option>
        <option value="5+">5+ Personen</option>
      </select>
    </div>
    
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Ihr Name</label>
      <input type="text" name="name" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-yellow-500 focus:border-transparent" required>
    </div>
    
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">E-Mail</label>
      <input type="email" name="email" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-yellow-500 focus:border-transparent" required>
    </div>
    
    <button type="submit" class="w-full bg-yellow-600 text-white py-3 rounded-lg font-semibold hover:bg-yellow-700 transition">
      <span class="button-text">Kostenloses Angebot anfordern</span>
      <span class="loading-text hidden">Wird gesendet...</span>
    </button>
    
    <p class="text-xs text-gray-500 text-center">
      Unverbindlich • Kostenlos • Schnelle Antwort
    </p>
  </form>
  
  <!-- Success/Error Messages -->
  <div id="booking-messages" class="hidden mt-4">
    <div id="booking-success-message" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
      <strong>Vielen Dank!</strong> Ihre Nachricht wurde erfolgreich gesendet. Wir melden uns innerhalb von 1-3 Stunden bei Ihnen.
    </div>
    
    <div id="booking-error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
      <strong>Fehler!</strong> Bitte versuchen Sie es erneut oder kontaktieren Sie uns direkt per WhatsApp.
    </div>
  </div>
  
  <!-- Trust Signals -->
  <div class="mt-6 pt-6 border-t border-gray-200">
    <div class="grid grid-cols-2 gap-3 text-xs text-gray-600">
      <div class="flex items-center">
        <span class="text-green-500 mr-1">🔒</span>
        <span>SSL Verschlüsselt</span>
      </div>
      <div class="flex items-center">
        <span class="text-green-500 mr-1">✅</span>
        <span>500+ Kunden</span>
      </div>
            <div class="flex items-center">
              <span class="text-green-500 mr-1">🏆</span>
              <span>Geprüfte Kerala-Partner</span>
            </div>
      <div class="flex items-center">
        <span class="text-green-500 mr-1">🇩🇪</span>
        <span>Deutschsprachig</span>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('quickBookingForm');
  if (!form) {
    console.error('Quick booking form not found');
    return;
  }
  
  form.addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Get message elements
    const messages = document.getElementById('booking-messages');
    const successMsg = document.getElementById('booking-success-message');
    const errorMsg = document.getElementById('booking-error-message');
    const buttonText = this.querySelector('.button-text');
    const loadingText = this.querySelector('.loading-text');
    
    // Hide any previous messages
    messages.classList.add('hidden');
    successMsg.classList.add('hidden');
    errorMsg.classList.add('hidden');
    
    // Check if EmailJS is loaded
    if (typeof emailjs === 'undefined') {
      console.error('EmailJS not loaded');
      errorMsg.classList.remove('hidden');
      messages.classList.remove('hidden');
      return;
    }
    
    // Test EmailJS initialization
    console.log('EmailJS loaded:', typeof emailjs);
    console.log('EmailJS version:', emailjs.version);
    
    const formData = new FormData(this);
    const bookingData = {
      tour: '{{ .Title }}',
      date: formData.get('travelDate'),
      participants: formData.get('participants'),
      name: formData.get('name'),
      email: formData.get('email'),
      source: 'Quick Booking Widget'
    };
    
    // Validate required fields
    if (!bookingData.name || !bookingData.email || !bookingData.date || !bookingData.participants) {
      errorMsg.classList.remove('hidden');
      messages.classList.remove('hidden');
      return;
    }
    
    // Show loading state
    const submitButton = this.querySelector('button[type="submit"]');
    buttonText.classList.add('hidden');
    loadingText.classList.remove('hidden');
    submitButton.disabled = true;
    
    console.log('Sending booking request:', bookingData);
    
    // Add timeout to prevent hanging requests
    const emailPromise = emailjs.send('service_6n7cbrb', 'template_contact', {
      from_name: bookingData.name,
      from_email: bookingData.email,
      subject: `Angebotsanfrage: ${bookingData.tour}`,
      message: `Neue Angebotsanfrage für eine Reise:

Tour: ${bookingData.tour}
Reisedatum: ${bookingData.date}
Anzahl Personen: ${bookingData.participants}

Bitte erstellen Sie ein individuelles Angebot und senden Sie es an: ${bookingData.email}

---
Diese Nachricht wurde über das Angebotsformular auf ayurveda-kerala.de gesendet.`
    });
    
    // Add timeout wrapper
    const timeoutPromise = new Promise((_, reject) => {
      setTimeout(() => reject(new Error('Request timeout - EmailJS service not responding')), 10000);
    });
    
    Promise.race([emailPromise, timeoutPromise])
    .then(function(response) {
      console.log('Email sent successfully:', response);
      // Show success message
      successMsg.classList.remove('hidden');
      messages.classList.remove('hidden');
      form.reset();
    })
    .catch(function(error) {
      console.error('Email sending failed:', error);
      console.error('Error details:', {
        status: error.status,
        text: error.text,
        message: error.message,
        stack: error.stack
      });
      
      // Show error message
      errorMsg.classList.remove('hidden');
      messages.classList.remove('hidden');
    })
    .finally(function() {
      // Reset button state
      buttonText.classList.remove('hidden');
      loadingText.classList.add('hidden');
      submitButton.disabled = false;
    });
  });
});
</script>
