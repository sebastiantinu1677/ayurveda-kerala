<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes">

  <title>{{ if .Title }}{{ .Title }} | Kerala Reisen{{ else }}Kerala Reisen – Authentische Reisen nach Kerala, Indien{{ end }}</title>
  <meta name="description" content="{{ with .Description }}{{ . }}{{ else }}Kerala Reisen: Ayurveda-Kuren, Yoga-Retreats, Rundreisen und Backwaters-Erlebnisse in Kerala, Indien.{{ end }}">
  <meta name="keywords" content="{{ with .Params.keywords }}{{ . }}{{ else }}{{ with .Site.Params.keywords }}{{ . }}{{ else }}Kerala Reisen, Ayurveda Kur, Yoga Retreat, Indien Reisen, Backwaters, deutschsprachige Beratung{{ end }}{{ end }}" />
  <meta name="author" content="{{ with .Site.Params.author }}{{ . }}{{ else }}Kerala Reisen{{ end }}" />
  <meta name="robots" content="index,follow,max-image-preview:large" />
  <meta name="googlebot" content="index,follow,max-snippet:-1,max-image-preview:large,max-video-preview:-1" />
  <meta name="bingbot" content="index,follow" />
  <meta name="language" content="{{ with .Site.Params.language }}{{ . }}{{ else }}de{{ end }}" />
  <meta name="geo.region" content="DE-SH" />
  <meta name="geo.placename" content="Kiel" />
  <meta name="geo.position" content="54.3233;10.1228" />
  <meta name="ICBM" content="54.3233, 10.1228" />
  <!-- Resource Hints for Performance -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin>
  <link rel="preconnect" href="https://cdn.kiprotect.com" crossorigin>
  <link rel="dns-prefetch" href="//fonts.googleapis.com">
  <link rel="dns-prefetch" href="//www.google-analytics.com">
  <link rel="dns-prefetch" href="//www.googletagmanager.com">
  
  <!-- Critical resources will be loaded when needed -->
  
  <!-- Font optimization -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
  
  <!-- Font files will be loaded by the stylesheet above -->

  <link rel="icon" href="{{ .Site.Params.favicon }}" type="image/x-icon">
  <!-- Critical CSS - Inline for faster loading -->
  <style>
    {{ readFile "static/css/critical.css" | safeCSS }}
  </style>
  
  <!-- Non-critical CSS - Load asynchronously -->
  <link rel="preload" href="{{ .Site.BaseURL }}css/tailwind.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="{{ .Site.BaseURL }}css/tailwind.css"></noscript>
  
  <link rel="preload" href="{{ .Site.BaseURL }}css/custom.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="{{ .Site.BaseURL }}css/custom.css"></noscript>

  <!-- Klaro! Cookie Consent -->
  <link rel="stylesheet" type="text/css" href="https://cdn.kiprotect.com/klaro/latest/klaro.css"/>
  <script type="text/javascript" src="/js/klaro-config.js"></script>
  <script type="text/javascript" src="https://cdn.kiprotect.com/klaro/latest/klaro.js"></script>

  <!-- Google Analytics & Google Ads - Load directly (not controlled by Klaro) -->
  {{ if or .Site.Params.googleAnalytics .Site.Params.googleAds }}
  <script async src="https://www.googletagmanager.com/gtag/js?id={{ .Site.Params.googleAnalytics | default .Site.Params.googleAds }}"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    
    // Configure Google Analytics if available
    {{ with .Site.Params.googleAnalytics }}
    {{ if ne . "" }}
    gtag('config', '{{ . }}', {
      custom_map: {
        'custom_parameter_1': 'page_category',
        'custom_parameter_2': 'user_type'
      },
      send_page_view: true,
      anonymize_ip: true,
      allow_google_signals: true,
      allow_ad_personalization_signals: false
    });
    console.log('Google Analytics initialized with ID: {{ . }}');
    {{ end }}
    {{ end }}
    
    // Configure Google Ads if available
    {{ with .Site.Params.googleAds }}
    {{ if ne . "" }}
    gtag('config', '{{ . }}', {
      send_page_view: true
    });
    console.log('Google Ads tracking initialized with ID: {{ . }}');
    {{ end }}
    {{ end }}
  </script>
  {{ else }}
  <script>
    console.warn('No Google Analytics or Google Ads ID configured in config.toml');
  </script>
  {{ end }}


  <link rel="icon" href="/images/keralareisenLogo.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/keralareisenLogo.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/keralareisenLogo.png">
  <link rel="apple-touch-icon" href="/images/icons/apple-touch-icon.png">

  <!-- Open Graph -->
  <meta property="og:title" content="{{ if .Title }}{{ .Title }} | Kerala Reisen{{ else }}Kerala Reisen – Authentische Reisen nach Kerala{{ end }}" />
  <meta property="og:description" content="{{ with .Description }}{{ . }}{{ else }}Kerala Reisen: Ayurveda-Kuren, Yoga-Retreats, Rundreisen und Backwaters-Erlebnisse in Kerala, Indien.{{ end }}" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="{{ .Permalink }}" />
  <meta property="og:image" content="{{ with .Params.image }}{{ . | relURL }}{{ else }}{{ with .Site.Params.defaultImage }}{{ . | relURL }}{{ else }}/images/hero-backwaters.jpg{{ end }}{{ end }}" />
  <meta property="og:image:alt" content="{{ .Title }}" />
  <meta property="og:site_name" content="Kerala Reisen" />

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="{{ if .Title }}{{ .Title }} | Kerala Reisen{{ else }}Kerala Reisen – Authentische Reisen nach Kerala{{ end }}" />
  <meta name="twitter:description" content="{{ with .Description }}{{ . }}{{ else }}Kerala Reisen: Ayurveda-Kuren, Yoga-Retreats, Rundreisen und Backwaters-Erlebnisse in Kerala, Indien.{{ end }}" />
  <meta name="twitter:image" content="{{ with .Params.image }}{{ . | relURL }}{{ else }}{{ with .Site.Params.defaultImage }}{{ . | relURL }}{{ else }}/images/hero-backwaters.jpg{{ end }}{{ end }}" />

  <!-- Crisp Chat -->
  <script type="text/javascript">
  window.$crisp = [];
  window.CRISP_WEBSITE_ID = "b96ad9f7-853f-4c78-a0e6-a7eaa36eab93";
  (function() {
      d = document;
      s = d.createElement("script");
      s.src = "https://client.crisp.chat/l.js";
      s.async = 1;
      d.getElementsByTagName("head")[0].appendChild(s);
      
      // Wait for Crisp to load, then hide the default widget but keep it functional
      s.onload = function() {
        setTimeout(function() {
          // Hide the default widget button but keep the chat functional
          window.$crisp.push(["do", "chat:hide"]);
          console.log('Crisp loaded and default widget hidden');
        }, 2000);
      };
  })();
  </script>

  <!-- Advanced Analytics & Conversion Tracking -->
  <script>
  // Enhanced conversion tracking
  function trackConversion(eventName, value, currency = 'EUR') {
    if (typeof gtag !== 'undefined') {
      gtag('event', eventName, {
        'event_category': 'conversion',
        'event_label': eventName,
        'value': value,
        'currency': currency
      });
      
      // Also send to Google Ads (if Google Ads ID is configured)
      {{ with .Site.Params.googleAds }}
      gtag('event', 'conversion', {
        'send_to': '{{ . }}/' + eventName,
        'value': value,
        'currency': currency
      });
      {{ end }}
    }
  }
  
  // Track user interactions
  document.addEventListener('DOMContentLoaded', function() {
    // Track Netlify deployment info
    if (typeof gtag !== 'undefined') {
      gtag('event', 'page_view', {
        'event_category': 'deployment',
        'event_label': 'netlify',
        'custom_parameter_1': 'kerala-reisen.netlify.app'
      });
    }
    // Track form submissions
    document.addEventListener('submit', function(e) {
      if (e.target.id === 'leadCaptureForm') {
        trackConversion('lead_capture', 1);
      } else if (e.target.id === 'contactForm') {
        trackConversion('contact_form', 1);
      } else if (e.target.id === 'quickBookingForm') {
        trackConversion('booking_inquiry', 1);
      }
    });
    
    // Track button clicks
    document.addEventListener('click', function(e) {
      if (e.target.matches('a[href*="wa.me"]')) {
        trackConversion('whatsapp_click', 1);
      } else if (e.target.matches('a[href*="/kontakt/"]')) {
        trackConversion('contact_page_click', 1);
      } else if (e.target.matches('a[href*="/reisen/"]')) {
        trackConversion('tour_page_click', 1);
      } else if (e.target.matches('a[href*="/blog/"]')) {
        trackConversion('blog_click', 1);
      } else if (e.target.matches('button[data-action="book"]')) {
        trackConversion('book_now_click', 1);
      } else if (e.target.matches('button[data-action="quote"]')) {
        trackConversion('quote_request_click', 1);
      }
    });
    
    // Track scroll depth
    let maxScroll = 0;
    window.addEventListener('scroll', function() {
      const scrollPercent = Math.round((window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100);
      if (scrollPercent > maxScroll && scrollPercent % 25 === 0) {
        maxScroll = scrollPercent;
        trackConversion('scroll_depth_' + scrollPercent, 1);
      }
    });
    
    // Track time on page
    let startTime = Date.now();
    window.addEventListener('beforeunload', function() {
      const timeOnPage = Math.round((Date.now() - startTime) / 1000);
      trackConversion('time_on_page', timeOnPage);
    });
    
    // Reading progress bar
    const progressBar = document.getElementById('reading-progress');
    if (progressBar) {
      window.addEventListener('scroll', function() {
        const scrollTop = window.pageYOffset;
        const docHeight = document.body.scrollHeight - window.innerHeight;
        const scrollPercent = (scrollTop / docHeight) * 100;
        progressBar.style.width = scrollPercent + '%';
      });
    }
  });
  </script>

  <link rel="canonical" href="{{ .Site.BaseURL }}{{ .RelPermalink }}">
  <link rel="alternate" hreflang="de" href="{{ .Permalink }}" />
  <link rel="alternate" hreflang="x-default" href="{{ .Permalink }}" />
  
  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('/sw.js')
          .then(function(registration) {
            console.log('Service Worker registered successfully:', registration.scope);
          })
          .catch(function(error) {
            console.log('Service Worker registration failed:', error);
          });
      });
    }
  </script>
  
  <!-- Lazy Loading Script -->
  <script src="{{ .Site.BaseURL }}js/lazy-loading.js" defer></script>
  
  <!-- Enhanced Analytics -->
  <script src="{{ .Site.BaseURL }}js/analytics-enhanced.js" defer></script>
  
  <!-- Accessibility Enhancements -->
  <script src="{{ .Site.BaseURL }}js/accessibility.js" defer></script>
  
  <!-- CDN Assets -->
  {{ partial "cdn-assets.html" . }}
  
  <!-- HTTP/2 Server Push -->
  {{ partial "http2-push.html" . }}
  
  <!-- Security Headers -->
  {{ partial "security-headers.html" . }}
  
  <!-- Advanced SEO -->
  {{ partial "advanced-seo.html" . }}
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="{{ .Site.BaseURL }}manifest.json">
  <meta name="theme-color" content="#3CB371">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Kerala Reisen">
  <link rel="apple-touch-icon" href="{{ .Site.BaseURL }}images/webp/logo.webp">
  
  <!-- EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
    // Initialize EmailJS
    emailjs.init("JAtr_sIlUlFAvciuj");
  </script>
  
  <!-- Enhanced Scripts -->
  <script src="{{ .Site.BaseURL }}js/advanced-analytics.js" defer></script>
  <script src="{{ .Site.BaseURL }}js/accessibility-enhanced.js" defer></script>
  <script src="{{ .Site.BaseURL }}js/ux-enhancements.js" defer></script>
  <!-- Critical CSS Inline -->
  <style>
    /* Critical above-the-fold styles */
    body { font-family: system-ui, -apple-system, sans-serif; margin: 0; }
    .hero-title-gradient { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 25%, #d97706 50%, #059669 75%, #047857 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .hero-subtitle-glow { text-shadow: 0 0 20px rgba(255, 255, 255, 0.5); }
    .hero-badge { background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
    .btn-primary { font-size: 1rem; font-weight: 600; letter-spacing: 0.025em; }
    .card-enhanced { transition: all 0.3s ease; }
    .card-enhanced:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); }
  </style>
  
  <link rel="preload" href="/css/custom.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="/css/custom.css"></noscript>
  
  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('/sw.js')
          .then(function(registration) {
            console.log('SW registered: ', registration);
          })
          .catch(function(registrationError) {
            console.log('SW registration failed: ', registrationError);
          });
      });
    }
  </script>

  <!-- Enhanced Structured Data -->
  {{ partial "structured-data.html" . }}
  {{ partial "seo-enhancements.html" . }}
  {{ partial "meta-descriptions.html" . }}
  {{ partial "hreflang.html" . }}

  <!-- Reading Progress Bar -->
  <div id="reading-progress" class="fixed top-0 left-0 w-0 h-1 bg-yellow-600 z-50 transition-all duration-300"></div>
  
  <!-- Enhanced Lazy Loading -->
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    // Enhanced lazy loading with Intersection Observer
    if ('IntersectionObserver' in window) {
      const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const img = entry.target;
            if (img.dataset.src) {
              img.src = img.dataset.src;
              img.classList.remove('image-loading');
              img.classList.add('loaded');
              img.removeAttribute('data-src');
              observer.unobserve(img);
            }
          }
        });
      }, {
        rootMargin: '50px 0px',
        threshold: 0.01
      });

      // Observe all images with data-src
      document.querySelectorAll('img[data-src]').forEach(img => {
        img.classList.add('image-loading');
        imageObserver.observe(img);
      });
    }

    // WebP support detection
    function supportsWebP() {
      return new Promise((resolve) => {
        const webP = new Image();
        webP.onload = webP.onerror = () => resolve(webP.height === 2);
        webP.src = 'data:image/webp;base64,UklGRjoAAABXRUJQVlA4IC4AAACyAgCdASoCAAIALmk0mk0iIiIiIgBoSygABc6WWgAA/veff/0PP8bA//LwYAAA';
      });
    }

    // Add WebP class to body if supported
    supportsWebP().then(supported => {
      if (supported) {
        document.documentElement.classList.add('webp');
      } else {
        document.documentElement.classList.add('no-webp');
      }
    });
  });
  </script>

</head>
